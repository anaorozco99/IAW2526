CREATE TABLE FABRICANTES(
  COD_FABRICANTE NUMBER(3) CONSTRAINT PK_FA PRIMARY KEY,
  NOMBRE VARCHAR2(15) CONSTRAINT CK_NO CHECK(NOMBRE=UPPER(NOMBRE)), 
  PAIS VARCHAR2(15) CONSTRAINT CK_PA CHECK(PAIS=UPPER(PAIS)) 
);


REM **** TABLA ARTICULOS
CREATE TABLE ARTICULOS(
  ARTICULO VARCHAR2(20),
  COD_FABRICANTE NUMBER(3),
  PESO NUMBER(3) CONSTRAINT CK1_AR CHECK (PESO>0),
  CATEGORIA  VARCHAR2(10),
  PRECIO_VENTA NUMBER (4)CONSTRAINT CK2_AR CHECK (PRECIO_VENTA>0),
  PRECIO_COSTO NUMBER (4) CONSTRAINT CK3_AR CHECK (PRECIO_COSTO>0),
  EXISTENCIAS NUMBER (5),
  CONSTRAINT PK_ART PRIMARY KEY (ARTICULO, COD_FABRICANTE, PESO, CATEGORIA),
  CONSTRAINT FK_AR_FA FOREIGN KEY (COD_FABRICANTE) REFERENCES FABRICANTES,
  CONSTRAINT CK_CAT CHECK(CATEGORIA IN('Primera','Segunda', 'Tercera'))
);

REM ************* TABLA TIENDAS
CREATE TABLE TIENDAS(
  NIF VARCHAR2(10)CONSTRAINT PK_TI PRIMARY KEY,
  NOMBRE  VARCHAR2(20),
  DIRECCIÓN VARCHAR2(20),
  POBLACIÓN VARCHAR2(20),
  PROVINCIA VARCHAR2(20)CONSTRAINT CK_PRO CHECK(PROVINCIA=UPPER(PROVINCIA)), 
  CODPOSTAL NUMBER(5)
);

REM *********** TABLA PEDIDOS
CREATE TABLE PEDIDOS(
  NIF VARCHAR2(10) CONSTRAINT FK_PE_TI REFERENCES TIENDAS,
  ARTICULO VARCHAR2(20),
  COD_FABRICANTE NUMBER(3) CONSTRAINT FK_PE_FA REFERENCES FABRICANTES,
  PESO NUMBER(3),
  CATEGORIA VARCHAR2(10),
  FECHA_PEDIDO DATE,
  UNIDADES_PEDIDAS  NUMBER(4)CONSTRAINT CK_PEUP CHECK (UNIDADES_PEDIDAS>0),
  CONSTRAINT PK_PED PRIMARY KEY
       (NIF,ARTICULO, COD_FABRICANTE, PESO, CATEGORIA, FECHA_PEDIDO),
  CONSTRAINT CK_CATPE CHECK(CATEGORIA IN('Primera','Segunda','Tercera')),
  CONSTRAINT FK_PE_AR FOREIGN KEY
        (ARTICULO, COD_FABRICANTE, PESO, CATEGORIA) REFERENCES ARTICULOS
         ON DELETE CASCADE
);

REM ************* TABLA VENTAS
CREATE TABLE VENTAS(
    NIF VARCHAR2(10) CONSTRAINT FK_VE_TI REFERENCES TIENDAS,
    ARTICULO VARCHAR2(20),
    COD_FABRICANTE NUMBER(3) CONSTRAINT FK_VE_FA REFERENCES FABRICANTES,
    PESO NUMBER(3),
    CATEGORIA VARCHAR2(10) 
CONSTRAINT CK_CATVE CHECK(CATEGORIA IN('Primera','Segunda','Tercera')),
    FECHA_VENTA DATE,
    UNIDADES_VENDIDAS  NUMBER(4)
CONSTRAINT CK_VEUV CHECK (UNIDADES_VENDIDAS>0),
    CONSTRAINT PK_VEN PRIMARY KEY
      (NIF,ARTICULO, COD_FABRICANTE, PESO, CATEGORIA, FECHA_VENTA),
    CONSTRAINT FK_VEAR FOREIGN KEY
        (ARTICULO, COD_FABRICANTE, PESO, CATEGORIA) REFERENCES ARTICULOS
        ON DELETE CASCADE
);

INSERT INTO FABRICANTES VALUES(10,'CALVO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(15,'LU', 'BELGICA');
INSERT INTO FABRICANTES VALUES(20,'BARILLA', 'ITALIA');
INSERT INTO FABRICANTES VALUES(25,'GALLO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(30,'PRESIDENT', 'FRANCIA');



INSERT INTO ARTICULOS VALUES ('Macarrones',20, 1, 'Primera',10,9,120);
INSERT INTO ARTICULOS VALUES ('Tallarines',20, 2, 'Primera',12,10,100);
INSERT INTO ARTICULOS VALUES ('Tallarines',20, 1, 'Segunda',9,5,100);
INSERT INTO ARTICULOS VALUES ('Macarrones',20, 1, 'Tercera',8,5,100);
INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Primera',20,15,220);
INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Segunda',15,10,220);
INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Tercera',10,5,220);
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1,'Primera',25,20,200);
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1, 'Segunda',20,16,200);
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1,'Tercera',15,10,220);
INSERT INTO ARTICULOS VALUES ('Mejillones',10, 1,'Tercera',9,5,200);
INSERT INTO ARTICULOS VALUES ('Mejillones',10, 1, 'Primera',20,15,300);
INSERT INTO ARTICULOS VALUES ('Macarrones',25, 1, 'Primera',9,6,150);
INSERT INTO ARTICULOS VALUES ('Tallarines',25, 1, 'Primera',10,9,100);
INSERT INTO ARTICULOS VALUES ('Fideos',25, 1, 'Segunda',7,5,100);
INSERT INTO ARTICULOS VALUES ('Fideos',25, 1, 'Primera',10,8,100);
INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Primera',10,8,100);
INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Segunda',7,5,100);
INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Tercera',5,4,100);
INSERT INTO ARTICULOS VALUES ('Barquillos',15, 1, 'Primera',10,8,100);
INSERT INTO ARTICULOS VALUES ('Barquillos',15, 1, 'Segunda',10,8,100);
INSERT INTO ARTICULOS VALUES ('Canutillos',15, 2, 'Primera',17,15,110);
INSERT INTO ARTICULOS VALUES ('Canutillos',15, 2, 'Segunda',12,15,110);
INSERT INTO ARTICULOS VALUES ('Leche entera',30, 1,'Primera',11,10,300);
INSERT INTO ARTICULOS VALUES ('Leche desnat.',30, 1,'Primera',12,10,300);
INSERT INTO ARTICULOS VALUES ('Leche semi.',30, 1,'Primera',13,11,300);
INSERT INTO ARTICULOS VALUES ('Leche entera',30, 2,'Primera',21,20,300);
INSERT INTO ARTICULOS VALUES ('Leche desnat.',30, 2,'Primera',22,20,300);
INSERT INTO ARTICULOS VALUES ('Leche semi.',30, 2,'Primera',23,21,300);
INSERT INTO ARTICULOS VALUES ('Mantequilla',30, 1,'Primera',51,40,200);
INSERT INTO ARTICULOS VALUES ('Mantequilla',30, 1,'Segunda',45,34,200);



INSERT INTO TIENDAS VALUES('1111-A','Almacenes Pérez', 'C/Toledo, 20',
 'Siguenza','GUADALAJARA',19104); 
INSERT INTO TIENDAS VALUES('5555-B','La gacela', 'C/Santander Rios, 45',
 'Azuqueca','GUADALAJARA', 19209);
INSERT INTO TIENDAS VALUES('2222-A','Comestibles Rodolfo', 
'C/ del Val s/n', 'Alcalá de Henares','MADRID',28804);
INSERT INTO TIENDAS VALUES('4444-A','La Pasta Gansa', 'C/Alcalá, 2',
 'Ajalvir','MADRID', 28765);
 INSERT INTO TIENDAS VALUES('3333-A','Ultramarinos Montse',
  'Avda. Pio 10', 'Toledo','TOLEDO',45100);
INSERT INTO TIENDAS VALUES('4141-B','Todo Toledo',
 'C/Avila 24', 'Talavera','TOLEDO',45199);



ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY';

INSERT INTO PEDIDOS VALUES ('5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('18/02/2022'), 30);
INSERT INTO PEDIDOS VALUES ('5555-B','Atún',10, 3, 'Primera',
TO_DATE('21/02/2022'), 10);
INSERT INTO PEDIDOS VALUES ('5555-B','Atún',10, 3, 'Segunda',
TO_DATE('11/03/2022'), 4);
INSERT INTO PEDIDOS VALUES ('5555-B','Sardinillas',10, 1, 'Segunda', 
TO_DATE('11/03/2022'), 10);
INSERT INTO PEDIDOS VALUES ('5555-B','Macarrones',25, 1, 'Primera',
TO_DATE('14/04/2022'), 12);
INSERT INTO PEDIDOS VALUES ('5555-B','Fideos',25, 1, 'Segunda', 
TO_DATE('18/05/2022'), 24);
INSERT INTO PEDIDOS VALUES ('5555-B','Fideos',25, 1, 'Segunda', 
TO_DATE('19/05/2022'), 20);
INSERT INTO PEDIDOS VALUES ('5555-B','Galletas Cuadradas',
15, 1, 'Segunda', TO_DATE('20/06/2022'), 15);

INSERT INTO PEDIDOS VALUES ('1111-A','Barquillos',15, 1, 'Primera',
TO_DATE('20/02/2022'), 10);

INSERT INTO PEDIDOS VALUES ('1111-A','Canutillos',15, 2, 'Segunda',
TO_DATE('10/04/2022'), 12);
INSERT INTO PEDIDOS VALUES ('1111-A','Leche semi.',30, 1, 'Primera',
TO_DATE('24/06/2022'), 5);
INSERT INTO PEDIDOS VALUES ('1111-A','Leche semi.',30, 2, 'Primera',
TO_DATE('04/07/2022'), 11);
INSERT INTO PEDIDOS VALUES ('1111-A','Mantequilla',30, 1, 'Primera', 
TO_DATE('10/07/2022'), 10);

INSERT INTO PEDIDOS VALUES ('4141-B','Macarrones',20, 1, 'Primera',
TO_DATE('16/04/2022'), 30);
INSERT INTO PEDIDOS VALUES ('4141-B','Atún',10, 3, 'Primera',
TO_DATE('21/06/2022'), 10);
INSERT INTO PEDIDOS VALUES ('4141-B','Atún',10, 3, 'Segunda',
TO_DATE('12/08/2022'), 9);


INSERT INTO PEDIDOS VALUES ('2222-A','Sardinillas',10, 1,
 'Segunda', TO_DATE('12/08/2022'),20);
INSERT INTO PEDIDOS VALUES ('2222-A','Sardinillas',10, 1, 
'Tercera', TO_DATE('12/08/2022'),22);
INSERT INTO PEDIDOS VALUES('2222-A','Mejillones',10,1,
 'Primera',SYSDATE,1000);

INSERT INTO PEDIDOS VALUES ('3333-A','Macarrones',25, 1,
 'Primera',TO_DATE('10/11/2022'),8);
INSERT INTO PEDIDOS VALUES ('3333-A','Tallarines',25, 1, 
'Primera', TO_DATE('12/11/2022'),9);
 INSERT INTO PEDIDOS VALUES ('3333-A','Fideos',25, 1, 
'Primera', TO_DATE('15/11/2022'),11);
 INSERT INTO PEDIDOS VALUES ('3333-A','Galletas Cuadradas',
15, 1, 'Primera', TO_DATE('20/11/2022'),6);
INSERT INTO PEDIDOS VALUES ('3333-A','Barquillos',15, 1, 
'Segunda', TO_DATE('20/11/2022'),40);
 INSERT INTO PEDIDOS VALUES ('3333-A','Canutillos',15, 2, 
'Segunda', TO_DATE('20/11/2022'),10);





INSERT INTO VENTAS VALUES ('5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('19/02/2022'), 5);
INSERT INTO VENTAS VALUES ('5555-B','Atún',10, 3, 'Primera',
TO_DATE('19/02/2022'), 6);
INSERT INTO VENTAS VALUES ('5555-B','Atún',10, 3, 'Segunda',
TO_DATE('20/03/2022'), 15);
INSERT INTO VENTAS VALUES ('5555-B','Sardinillas',10, 1, 'Segunda', 
TO_DATE('20/03/2022'), 8);
INSERT INTO VENTAS VALUES ('5555-B','Macarrones',25, 1, 'Primera',
TO_DATE('17/04/2022'), 2);
INSERT INTO VENTAS VALUES ('5555-B','Fideos',25, 1, 'Segunda', 
TO_DATE('18/05/2022'), 14);
INSERT INTO VENTAS VALUES ('5555-B','Leche semi.',30, 1, 'Primera',
TO_DATE('24/06/2022'), 5);

INSERT INTO VENTAS VALUES ('2222-A','Galletas Cuadradas',
15, 1, 'Segunda', TO_DATE('20/06/2022'), 5);
INSERT INTO VENTAS VALUES ('2222-A','Barquillos',15, 1, 'Primera',
TO_DATE('20/02/2022'), 6);
INSERT INTO VENTAS VALUES ('2222-A','Canutillos',15, 2, 'Segunda',
TO_DATE('10/06/2022'), 2);
INSERT INTO VENTAS VALUES ('2222-A','Sardinillas',10, 1,
 'Segunda', TO_DATE('15/08/2022'),5);
INSERT INTO VENTAS VALUES ('2222-A','Sardinillas',10, 1, 
'Tercera', TO_DATE('15/08/2022'),5);


INSERT INTO VENTAS VALUES ('3333-A','Leche semi.',30, 2, 'Primera',
TO_DATE('06/07/2022'), 11);
INSERT INTO VENTAS VALUES ('3333-A','Mantequilla',30, 1, 'Primera', 
TO_DATE('16/07/2022'), 10);
INSERT INTO VENTAS VALUES ('3333-A','Macarrones',20, 1, 'Primera',
TO_DATE('26/04/2022'), 30);
INSERT INTO VENTAS VALUES ('3333-A','Atún',10, 3, 'Primera',
TO_DATE('26/04/2022'), 10);
INSERT INTO VENTAS VALUES ('3333-A','Barquillos',15, 1, 
'Segunda', TO_DATE('25/11/2022'),4);
 INSERT INTO VENTAS VALUES ('3333-A','Canutillos',15, 2, 
'Segunda', TO_DATE('25/11/2022'),4);

INSERT INTO VENTAS VALUES ('4141-B','Atún',10, 3, 'Segunda',
TO_DATE('12/08/2022'), 2);

INSERT INTO VENTAS VALUES ('4141-B','Macarrones',25, 1,
 'Primera',TO_DATE('10/11/2022'),2);
INSERT INTO VENTAS VALUES ('4141-B','Tallarines',25, 1, 
'Primera', TO_DATE('11/11/2022'),3);
INSERT INTO VENTAS VALUES ('4141-B','Canutillos',15, 2, 
'Segunda', TO_DATE('11/11/2022'),8);

commit;

/*1A Dar de alta una tienda con los siguientes datos: NIF: 5555-C , Nombre: La Tiendecita, Dirección
'C/Arroyo', Población y Provincia: Madrid, C.P.: 28766*/

INSERT INTO TIENDAS VALUES ('5555-C', 'La Tiendecita', 'C/Arroyo', 'Madrid', 'MADRID', 28766);

/*1B Abastecer la tienda con nif 5555-C con 20 unidades de cada uno de los artículos existentes
(realizar inserción en la tabla pedidos).*/

INSERT INTO PEDIDOS
SELECT '5555-C', ARTICULO, COD_FABRICANTE, PESO, CATEGORIA, SYSDATE, 20 FROM ARTICULOS;

/*2A Dar de alta una tienda en la provincia de Sevilla con los siguientes datos: NIF: 6666-A, Nombre:
La Tiendecita II, Dirección 'C/Callecita', C.P: 28767);*/

INSERT INTO TIENDAS VALUES ('6666-A', 'La Tiendecita II', 'C/Callecita', 'Sevilla', 'SEVILLA', 28767);

/*2B Abastecer la tienda de la provincia de sevilla (insertar en pedidos) con 30 unidades de artículos
de la marca de fabricante ‘GALLO’. (La fecha será la del sistema: sysdate y suponemos que no
conocemos el nif de la tienda)*/

INSERT INTO PEDIDOS
SELECT NIF, ARTICULO, AR.COD_FABRICANTE, PESO, CATEGORIA, SYSDATE, 30
FROM ARTICULOS AR, TIENDAS, FABRICANTES FA
WHERE UPPER(PROVINCIA) = 'SEVILLA' AND AR.COD_FABRICANTE = FA.COD_FABRICANTE AND UPPER(FA.NOMBRE) = 'GALLO';

/*3 Realizar una venta para todas las tiendas de ‘TOLEDO’ de 10 unidades en los artículos de ‘Primera’
categoría. (Fecha: la del sistema)*/

INSERT INTO VENTAS
SELECT NIF, ARTICULO, COD_FABRICANTE, PESO, CATEGORIA, SYSDATE, 10
FROM ARTICULOS, TIENDAS
WHERE UPPER(PROVINCIA) = 'TOLEDO' AND UPPER(CATEGORIA) = 'PRIMERA';

/*4 Cambiar los datos de la tienda con NIF ‘1111-A’ igualándolos a los de la tienda con NIF ‘2222-A’.*/

UPDATE TIENDAS
SET (NOMBRE, DIRECCIÓN, POBLACIÓN, PROVINCIA, CODPOSTAL) = (SELECT NOMBRE, DIRECCIÓN, POBLACIÓN, PROVINCIA, CODPOSTAL FROM TIENDAS WHERE NIF = '2222-A')
WHERE NIF = '1111-A';

/*5 Cambiar todos los artículos de ‘Primera’ categoría a ‘Cuarta’ categoría del país ‘ITALIA’.
Nota: Antes de realizar el borrado, las filas de la tabla pedido y ventas que hacen referencia a dicho
artículos se han de borrar y la tabla artículos ha de admitir el valor Cuarta en el campo categoria*/

ALTER TABLE ARTICULOS
DROP CONSTRAINT CK_CAT;

ALTER TABLE ARTICULOS
ADD CONSTRAINT CK_CAT CHECK (CATEGORIA IN('Primera', 'Segunda', 'Tercera', 'Cuarta'));

DELETE PEDIDOS WHERE UPPER(CATEGORIA) = 'PRIMERA' AND COD_FABRICANTE = (SELECT COD_FABRICANTE FROM FABRICANTES WHERE UPPER(PAIS) = 'ITALIA');
DELETE VENTAS WHERE UPPER(CATEGORIA) = 'PRIMERA' AND COD_FABRICANTE = (SELECT COD_FABRICANTE FROM FABRICANTES WHERE UPPER(PAIS) = 'ITALIA');

UPDATE ARTICULOS
SET CATEGORIA = 'Cuarta'
WHERE UPPER(CATEGORIA) = 'PRIMERA' AND COD_FABRICANTE IN (SELECT COD_FABRICANTE FROM FABRICANTES WHERE UPPER(PAIS) = 'ITALIA');

/*6 Modificar aquellos pedidos en los que la cantidad pedida sea superior a las existencias del artículo,
asignando el 20 por 100 de las existencias a la cantidad que se ha pedido.*/

UPDATE PEDIDOS PE
SET UNIDADES_PEDIDAS = (SELECT EXISTENCIAS * 0.20 FROM ARTICULOS AR 
WHERE AR.ARTICULO = PE.ARTICULO AND AR.COD_FABRICANTE = PE.COD_FABRICANTE AND AR.PESO = PE.PESO AND AR.CATEGORIA = PE.CATEGORIA)
WHERE UNIDADES_PEDIDAS > (SELECT EXISTENCIAS FROM ARTICULOS AR
WHERE AR.ARTICULO = PE.ARTICULO AND AR.COD_FABRICANTE = PE.COD_FABRICANTE AND AR.PESO = PE.PESO AND AR.CATEGORIA = PE.CATEGORIA);

/*7 Eliminar los artículos que no hayan tenido compras ni ventas.*/

DELETE ARTICULOS
WHERE (ARTICULO, COD_FABRICANTE, PESO, CATEGORIA) NOT IN (SELECT ARTICULO, COD_FABRICANTE, PESO, CATEGORIA FROM PEDIDOS)
AND (ARTICULO, COD_FABRICANTE, PESO, CATEGORIA) NOT IN (SELECT ARTICULO, COD_FABRICANTE, PESO, CATEGORIA FROM VENTAS);

/*8 Borrar los pedidos de ‘Primera’ categoría cuyo país de procedencia sea ‘BÉLGICA’.*/

DELETE PEDIDOS
WHERE UPPER(CATEGORIA) = 'PRIMERA' AND COD_FABRICANTE IN (SELECT COD_FABRICANTE FROM FABRICANTES WHERE UPPER(PAIS) = 'BELGICA');

/*9 Borrar los pedidos que no tengan tienda.*/

DELETE PEDIDOS
WHERE NIF NOT IN (SELECT NIF FROM TIENDAS);

/*10 Restar uno a las unidades de los últimos pedidos (los que tienen la última fecha) de la tienda con NIF
‘5555-B’.*/

UPDATE PEDIDOS
SET UNIDADES_PEDIDAS = UNIDADES_PEDIDAS - 1
WHERE NIF = '5555-B' AND FECHA_PEDIDO = (SELECT MAX(FECHA_PEDIDO) FROM PEDIDOS WHERE NIF = '5555-B');







