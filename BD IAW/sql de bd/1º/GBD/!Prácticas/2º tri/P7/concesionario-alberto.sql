/* Se crean las tablas relativas a la base de datos
correspondiente a la venta de coches

Inicialmente se borran los objetos de la base de datos. 
Después se crean las tablas y las restricciones definidas 
en el esquema propuesto
*/

DROP TABLE MARCO CASCADE CONSTRAINTS;
DROP TABLE DISTRIBUCION CASCADE CONSTRAINTS;
DROP TABLE VENTAS CASCADE CONSTRAINTS;
DROP TABLE MARCAS CASCADE CONSTRAINTS;
DROP TABLE CLIENTES CASCADE CONSTRAINTS;
DROP TABLE COCHES CASCADE CONSTRAINTS;
DROP TABLE CONCESIONARIOS CASCADE CONSTRAINTS;


CREATE TABLE MARCAS ( 
  cifm CHAR(4), 
  nombre VARCHAR2(15) NOT NULL,  
  ciudad VARCHAR2(20),  
      CONSTRAINT  pk_marca  
      PRIMARY KEY (cifm));
     
CREATE TABLE CLIENTES ( 
  dni CHAR(4), 
  nombre VARCHAR2(10),
  apellido VARCHAR2(15),
  ciudad VARCHAR2(20),
     CONSTRAINT pk_cl
       PRIMARY KEY (dni));
     
CREATE TABLE COCHES (   
  codcoche CHAR(4),
  nombre VARCHAR2(15),
  modelo VARCHAR2(15),
    CONSTRAINT pk_coches
    PRIMARY KEY (codcoche));
    
CREATE TABLE CONCESIONARIOS (
  cifc CHAR(4),
  nombre VARCHAR2(15),
  ciudad VARCHAR2(20),
  CONSTRAINT pk_conce
  PRIMARY KEY (cifc));
  
CREATE TABLE DISTRIBUCION (
 cifc CHAR(4),
 codcoche CHAR(4),
 cantidad NUMBER(3) NOT NULL,
 CONSTRAINT pk_distrib
  PRIMARY KEY (cifc, codcoche),
 CONSTRAINT fk_dis_conc
   FOREIGN KEY (cifc) REFERENCES CONCESIONARIOS,
 CONSTRAINT ck_cant_dist
   CHECK (cantidad>=0));
     
CREATE TABLE VENTAS (
  cifc CHAR(4),
  dni CHAR (4),
  codcoche CHAR(4),
  color VARCHAR (15),
  CONSTRAINT pk_vent
    PRIMARY KEY (cifc,dni,codcoche),
  CONSTRAINT fk_vent_conce
     FOREIGN KEY (cifc) REFERENCES CONCESIONARIOS,
  CONSTRAINT fk_vent_cl
    FOREIGN KEY (dni) REFERENCES CLIENTES,
  CONSTRAINT fk_vent_coche
     FOREIGN KEY (codcoche) REFERENCES COCHES);
     
CREATE TABLE MARCO (
   cifm CHAR(4),
   codcoche CHAR(4),
   CONSTRAINT pk_marco
     PRIMARY KEY (cifm, codcoche),
   CONSTRAINT fk_marco_marcas
      FOREIGN KEY (cifm) REFERENCES MARCAS,
   CONSTRAINT fk_marco_coche
      FOREIGN KEY (codcoche) REFERENCES COCHES);     
       
 
REM BORRO LOS DATOS DE LA TABLAS
DELETE FROM DISTRIBUCION;
DELETE FROM MARCO;
DELETE FROM VENTAS;
DELETE FROM COCHES;
DELETE FROM CONCESIONARIOS;
DELETE FROM CLIENTES;
DELETE FROM MARCAS;
REM INSERTO EN MARCAS
INSERT INTO MARCAS VALUES ('0001','Seat','Madrid');
INSERT INTO MARCAS VALUES ('0002','Renault','Barcelona');
INSERT INTO MARCAS VALUES ('0003','Citroen','Valencia');
INSERT INTO MARCAS VALUES ('0004','Audi','Madrid');
INSERT INTO MARCAS VALUES ('0005','Opel','Bilbao');
INSERT INTO MARCAS VALUES ('0006','BMW','Barcelona');
REM INSERTO EN CLIENTES
INSERT INTO CLIENTES VALUES ('0001','Luis','Garcia','Madrid');
INSERT INTO CLIENTES VALUES ('0002','Antonio','Lopez','Valencia');
INSERT INTO CLIENTES VALUES ('0003','Juan','Martin','Madrid');
INSERT INTO CLIENTES VALUES ('0004','Maria','Garcia','Madrid');
INSERT INTO CLIENTES VALUES ('0005','Javier','Gonzalez','Barcelona');
INSERT INTO CLIENTES VALUES ('0006','Ana','Lopez','Barcelona');
REM INSERTO EN CONCESIONARIOS
INSERT INTO CONCESIONARIOS VALUES ('0001','Acar','Madrid');
INSERT INTO CONCESIONARIOS VALUES ('0002','Bcar','Madrid');
INSERT INTO CONCESIONARIOS VALUES ('0003','Ccar','Barcelona');
INSERT INTO CONCESIONARIOS VALUES ('0004','Dcar','Valencia');
INSERT INTO CONCESIONARIOS VALUES ('0005','Ecar','Bilbao');
REM INSERTO EN COCHES
INSERT INTO COCHES VALUES ('0001','Ibiza','glx');
INSERT INTO COCHES VALUES ('0002','Ibiza','gti');
INSERT INTO COCHES VALUES ('0003','Ibiza','gtd');
INSERT INTO COCHES VALUES ('0004','Toledo','gtd');
INSERT INTO COCHES VALUES ('0005','Cordoba','gti');
INSERT INTO COCHES VALUES ('0006','Megane','1.6');
INSERT INTO COCHES VALUES ('0007','Megane','gti');
INSERT INTO COCHES VALUES ('0008','Laguna','gtd');
INSERT INTO COCHES VALUES ('0009','Laguna','td');
INSERT INTO COCHES VALUES ('0010','ZX','16v');
INSERT INTO COCHES VALUES ('0011','ZX','td');
INSERT INTO COCHES VALUES ('0012','Xantia','gtd');
INSERT INTO COCHES VALUES ('0013','A4','1.8');
INSERT INTO COCHES VALUES ('0014','A4','2.8');
INSERT INTO COCHES VALUES ('0015','Astra','caravan');
INSERT INTO COCHES VALUES ('0016','Astra','gti');
INSERT INTO COCHES VALUES ('0017','Corsa','1.4');
INSERT INTO COCHES VALUES ('0018','300','316i');
INSERT INTO COCHES VALUES ('0019','500','525i');
INSERT INTO COCHES VALUES ('0020','700','750i');
REM INSERTO EN VENTAS
INSERT INTO VENTAS VALUES ('0001','0001','0001','blanco');
INSERT INTO VENTAS VALUES ('0001','0002','0005','rojo');
INSERT INTO VENTAS VALUES ('0002','0003','0008','blanco');
INSERT INTO VENTAS VALUES ('0002','0001','0006','rojo');
INSERT INTO VENTAS VALUES ('0003','0004','0011','rojo');
INSERT INTO VENTAS VALUES ('0004','0005','0014','verde');
REM INSERTO EN MARCO
INSERT INTO MARCO VALUES ('0001','0001');
INSERT INTO MARCO VALUES ('0001','0002');
INSERT INTO MARCO VALUES ('0001','0003');
INSERT INTO MARCO VALUES ('0001','0004');
INSERT INTO MARCO VALUES ('0001','0005');
INSERT INTO MARCO VALUES ('0002','0006');
INSERT INTO MARCO VALUES ('0002','0007');
INSERT INTO MARCO VALUES ('0002','0008');
INSERT INTO MARCO VALUES ('0002','0009');
INSERT INTO MARCO VALUES ('0003','0010');
INSERT INTO MARCO VALUES ('0003','0011');
INSERT INTO MARCO VALUES ('0003','0012');
INSERT INTO MARCO VALUES ('0004','0013');
INSERT INTO MARCO VALUES ('0004','0014');
INSERT INTO MARCO VALUES ('0005','0015');
INSERT INTO MARCO VALUES ('0005','0016');
INSERT INTO MARCO VALUES ('0005','0017');
INSERT INTO MARCO VALUES ('0006','0018');
INSERT INTO MARCO VALUES ('0006','0019');
INSERT INTO MARCO VALUES ('0006','0020');
REM INSERTO EN DISTRIBUCION
INSERT INTO DISTRIBUCION VALUES ('0001','0001',3);
INSERT INTO DISTRIBUCION VALUES ('0001','0005',7);
INSERT INTO DISTRIBUCION VALUES ('0001','0006',7);
INSERT INTO DISTRIBUCION VALUES ('0002','0006',5);
INSERT INTO DISTRIBUCION VALUES ('0002','0008',10);
INSERT INTO DISTRIBUCION VALUES ('0002','0009',10);
INSERT INTO DISTRIBUCION VALUES ('0003','0010',5);
INSERT INTO DISTRIBUCION VALUES ('0003','0011',3);
INSERT INTO DISTRIBUCION VALUES ('0003','0012',5);
INSERT INTO DISTRIBUCION VALUES ('0004','0013',10);
INSERT INTO DISTRIBUCION VALUES ('0004','0014',5);
INSERT INTO DISTRIBUCION VALUES ('0005','0015',10);
INSERT INTO DISTRIBUCION VALUES ('0005','0016',20);
INSERT INTO DISTRIBUCION VALUES ('0005','0017',8);

/*CONSULTAS*/

/*1. Obtener el codigo del coche , nombre y modelo distribuido por algún concesionario de
Barcelona. No puede salir ninguna tupla repetida*/

SELECT CO.CODCOCHE, CO.NOMBRE, CO.MODELO 
FROM COCHES CO, CONCESIONARIOS CON, DISTRIBUCION DI 
WHERE CO.CODCOCHE = DI.CODCOCHE AND CON.CIFC = DI.CIFC AND UPPER(CIUDAD) = 'BARCELONA';

/*2. Obtener el código de los coches de aquellos coches vendidos a clientes de Madrid.*/

SELECT CO.CODCOCHE
FROM COCHES CO, CLIENTES CLI, VENTAS VEN
WHERE CO.CODCOCHE = VEN.CODCOCHE AND VEN.DNI = CLI.DNI AND UPPER(CIUDAD) = 'MADRID';

/*3. Obtener nombre y apellido de los clientes que han adquirido algun coche del concesionario
Dcar (Realizarlo con subconsulta)*/

SELECT CLI.NOMBRE, CLI.APELLIDO 
FROM CLIENTES CLI, CONCESIONARIOS CON, VENTAS VEN
WHERE CON.CIFC = VEN.CIFC AND CLI.DNI = VEN.DNI AND UPPER(CON.NOMBRE) = 'DCAR';

SELECT NOMBRE, APELLIDO
FROM CLIENTES
WHERE DNI IN (SELECT DNI FROM VENTAS WHERE CIFC IN (SELECT CIFC FROM CONCESIONARIOS WHERE UPPER(NOMBRE) = 'DCAR'));

/*4. Obtener el nombre y la cantidad total de coche que ha distribuido cada concesionario
(agrupamiento).*/

SELECT NOMBRE, SUM(CANTIDAD) 
FROM CONCESIONARIOS CON, DISTRIBUCION DIS 
WHERE CON.CIFC = DIS.CIFC 
GROUP BY NOMBRE;

/*5. Obtener el nombre de las marcas que tienen modelo gti*/

SELECT DISTINCT(MAR.NOMBRE) 
FROM COCHES CO, MARCAS MAR, MARCO MCO 
WHERE MAR.CIFM = MCO.CIFM AND CO.CODCOCHE = MCO.CODCOCHE AND UPPER(MODELO) = 'GTI';

/*6. Obtener los nombres de los coches que no tienen modelo gtd (usar operación de conjunto)*/

SELECT NOMBRE FROM COCHES 
MINUS 
SELECT NOMBRE FROM COCHES WHERE MODELO = 'gtd';

/*7. Obtener el cif de todos los concesionarios que disponen de una cantidad de coches
comprendida entre 10 y 18 unidades (agrupamiento con having).*/

SELECT CON.CIFC, SUM(CANTIDAD)
FROM CONCESIONARIOS CON, DISTRIBUCION DIS 
WHERE CON.CIFC = DIS.CIFC 
GROUP BY CON.CIFC 
HAVING SUM(CANTIDAD) BETWEEN 10 AND 18;

/*8. Obtener dni, nombre y apellido de todos los clientes, mostrando el código de coche
que han comprado.*/

SELECT CLI.DNI, NOMBRE, APELLIDO, CODCOCHE 
FROM CLIENTES CLI, VENTAS VEN 
WHERE CLI.DNI = VEN.DNI;

/*9. Obtener el codcoche de los coches que han sido adquiridos por un cliente de Madrid en
un concesionario de Madrid*/

SELECT CODCOCHE 
FROM VENTAS VEN, CONCESIONARIOS CON, CLIENTES CLI
WHERE CLI.DNI = VEN.DNI AND CON.CIFC = VEN.CIFC AND UPPER(CON.CIUDAD) = 'MADRID' AND UPPER(CLI.CIUDAD) ='MADRID';

/*10. Obtener los codche de los coches comprados en un concesionario de la misma ciudad
que el cliente que lo compra*/

SELECT CODCOCHE
FROM VENTAS VEN, CONCESIONARIOS CON, CLIENTES CLI
WHERE CLI.DNI = VEN.DNI AND CON.CIFC = VEN.CIFC AND CLI.CIUDAD = CON.CIUDAD;

/*11. Obtener todas las parejas de nombre de marcas que sean de la misma ciudad*/

SELECT MA1.NOMBRE, MA2.NOMBRE, MA1.CIUDAD, MA2.CIUDAD
FROM MARCAS MA1, MARCAS MA2
WHERE MA1.CIUDAD = MA2.CIUDAD AND MA1.NOMBRE > MA2.NOMBRE;

/*12. Obtener las parejas de modelos de coches cuyo nombre es el mismo y cuya marca es de
Bilbao*/

SELECT CO1.MODELO, CO2.MODELO
FROM COCHES CO1, COCHES CO2, MARCAS MAR, MARCO MCO
WHERE MAR.CIFM = MCO.CIFM AND CO1.CODCOCHE = MCO.CODCOCHE AND CO2.CODCOCHE = MCO.CODCOCHE AND CO1.NOMBRE = CO2.NOMBRE AND UPPER(CIUDAD) ='BILBAO';

/*13. Obtener el nombre y el apellido de los clientes que han adquieridos un coche modelo gti
de color blanco (realizar con subconsultas)*/

SELECT CLI.NOMBRE, APELLIDO
FROM CLIENTES CLI, VENTAS VEN, COCHES CO
WHERE CLI.DNI = VEN.DNI AND CO.CODCOCHE = VEN.CODCOCHE AND UPPER(COLOR) = 'BLANCO' AND UPPER(MODELO) = 'GTI';

SELECT NOMBRE, APELLIDO
FROM CLIENTES
WHERE DNI IN (SELECT DNI FROM VENTAS WHERE UPPER(COLOR) = 'BLANCO' AND CODCOCHE IN (SELECT CODCOCHE FROM COCHES WHERE UPPER(MODELO) = 'GTI'));









