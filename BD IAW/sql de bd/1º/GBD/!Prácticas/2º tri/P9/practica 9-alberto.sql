/*PARTE 1*/

--PREGUNTA 1

CREATE TABLE ALUMNOS (
   CODIGO VARCHAR2(20) CONSTRAINT PK_ALUMNOS PRIMARY KEY,
   NIF VARCHAR2(20) NOT NULL,
   NOMBRE VARCHAR2(20),
   APELLIDOS VARCHAR2(60),
   F_NACIM DATE,
   DIRECCION VARCHAR2(200)
);

CREATE TABLE ASIGNATURAS (
   CODIGO NUMBER(3,0) CONSTRAINT PK_ASIG PRIMARY KEY,
   NOMBRE VARCHAR2(50),
   CREDITOS NUMBER(2),
   ALUMNO_RESPONSABLE VARCHAR2(20) CONSTRAINT FK_ASIG_ALUM REFERENCES ALUMNOS
);

CREATE TABLE MATRICULA (
   ALUMNOS VARCHAR2(20) CONSTRAINT FK_MATRI_ALUM REFERENCES ALUMNOS,
   ASIGNATURA NUMBER(3,0) CONSTRAINT FK_MATRI_ASIG REFERENCES ASIGNATURAS,
   CURSO NUMBER(4),
   BECA CHAR(2) CONSTRAINT CK_BECA CHECK (BECA IN('SI','NO')),
   CONSTRAINT PK_MATRICULA PRIMARY KEY (ALUMNOS, ASIGNATURA)
);

ALTER SESSION SET NLS_DATE_FORMAT = 'DD/MM/YYYY';

INSERT INTO ALUMNOS VALUES ('12345A','12345678','Nombre 1','Apellidos 1','15/12/2000','Dirección 1,3ºA');
INSERT INTO ALUMNOS VALUES ('98745C','98745632C','Nombre 2','Apellidos 2','16/02/2001','Dirección 3,6ºb');

INSERT INTO ASIGNATURAS VALUES (11,'Informática',20,'12345A');
INSERT INTO ASIGNATURAS VALUES (12,'Matemáticas',15,'12345A');
INSERT INTO ASIGNATURAS VALUES (13,'Física',10,'98745C');

INSERT INTO MATRICULA VALUES ('12345A',11,2021,'SI');
INSERT INTO MATRICULA VALUES ('12345A',12,2022,'NO');
INSERT INTO MATRICULA VALUES ('98745C',13,2022,'NO');

--PREGUNTA 2

ALTER TABLE ASIGNATURAS ADD DEPENDE_DE NUMBER(3,0) CONSTRAINT FK_DEP_ASI REFERENCES ASIGNATURAS;

--PREGUNTA 3

ALTER TABLE MATRICULA DROP CONSTRAINT PK_MATRICULA;

ALTER TABLE MATRICULA ADD CONSTRAINT PK_MATRICULA PRIMARY KEY(ALUMNOS, ASIGNATURA, CURSO);

ALTER TABLE MATRICULA ADD NOTA_FINAL NUMBER(4,2);


/*PARTE 2*/


DROP TABLE UNIVERSIDAD cascade constraints; 

CREATE TABLE UNIVERSIDAD (
 CODIGO   NUMBER(4) NOT NULL,
 TIPO  CHAR(1),
 NOMBRE VARCHAR2(30),
 DIRECCION VARCHAR2(26),
 TELEFONO VARCHAR2(10),
 NUM_PLAZAS NUMBER(4),
CONSTRAINT PK_UNIVERSIDAD PRIMARY KEY (CODIGO)
 );

INSERT INTO UNIVERSIDAD VALUES (10,'S','Sevilla', 
'Avda. Los Molinos 25', '965-887654',538);
INSERT INTO UNIVERSIDAD VALUES (15,'P','Huelva', 'C/Las Musas s/n',
'985-112322',250);
INSERT INTO UNIVERSIDAD VALUES (22,'S', 'Cadiz', 'C/Mina 45',
'925-443400',300);
INSERT INTO UNIVERSIDAD VALUES (45,'P', 'Granada', 'C/Granada 5',
'926-202310',220);
INSERT INTO UNIVERSIDAD VALUES (50,'S', 'Malaga', 'C/Los Toreros 21',
'989-406090',310);

DROP TABLE TRABAJADOR cascade constraints; 

CREATE TABLE TRABAJADOR (
 CODIGO  NUMBER(4),
 DNI NUMBER(10),
 NOMBRE VARCHAR2(30),
 FUNCION VARCHAR2(15),
 SALARIO NUMBER (10),
CONSTRAINT PK_TRABAJADOR PRIMARY KEY (DNI),
CONSTRAINT FK_TRA_UNI FOREIGN KEY (CODIGO) REFERENCES UNIVERSIDAD
);

INSERT INTO TRABAJADOR VALUES (10,1112345,'Martinez Salas, Fernando',
'PROFESOR', 2200);
INSERT INTO TRABAJADOR VALUES (10,4123005,'Bueno Zarco, Elisa', 
'PROFESOR', 2200);
INSERT INTO TRABAJADOR VALUES (10,4122025,'Montes Garcia, M.Pilar', 
'PROFESOR', 2200);
INSERT INTO TRABAJADOR VALUES (15,1112346,'Rivera Silvestre, Ana',
'PROFESOR', 2050);
INSERT INTO TRABAJADOR VALUES (15,9800990, 'Ramos Ruiz, Luis',
'PROFESOR', 2050);
INSERT INTO TRABAJADOR VALUES (15,8660990, 'De Lucas Fdez, M.Angel',
'PROFESOR', 2050);

INSERT INTO TRABAJADOR VALUES (22,7650000, 'Ruiz Lafuente, Manuel',
'PROFESOR', 2200);
INSERT INTO TRABAJADOR VALUES (45,43526789, 'Serrano Laguna, Maria',
'PROFESOR', 2050);
INSERT INTO TRABAJADOR VALUES (15,41526779, 'Romero Flores, Petra',
'PROFESOR', 2150);

INSERT INTO TRABAJADOR VALUES (10,4480099,'Ruano Cerezo, Manuel',
'ADMINISTRATIVO', 1800);
INSERT INTO TRABAJADOR VALUES (15,1002345,'Albarran Serrano, Alicia',
'ADMINISTRATIVO', 1800);
INSERT INTO TRABAJADOR VALUES (15,7002660,'Muñoz Rey, Felicia',
'ADMINISTRATIVO', 1800);
INSERT INTO TRABAJADOR VALUES (22,5502678,'Marin Marin, Pedro',
'ADMINISTRATIVO', 1800);
INSERT INTO TRABAJADOR VALUES (22,6600980, 'Peinado Gil, Elena',
'CONSERJE', 1750);
INSERT INTO TRABAJADOR VALUES (45,4163222, 'Sarro Molina, Carmen',
'CONSERJE', 1750);


DROP TABLE CATEDRATICO cascade constraints; 

CREATE TABLE catedratico (
 CODIGO   NUMBER(4) NOT NULL,
 DNI          NUMBER(10),
 CATEDRA VARCHAR2(16),
 NPROF NUMBER(2),
CONSTRAINT PK_CATEDRATICO PRIMARY KEY (DNI),
CONSTRAINT FK_CAT_TRAB FOREIGN KEY(DNI) REFERENCES TRABAJADOR,
CONSTRAINT FK_CAT_UNI FOREIGN KEY (CODIGO) REFERENCES UNIVERSIDAD 
);


INSERT INTO CATEDRATICO VALUES (10,1112345,'INFORMATICA', 20);
INSERT INTO CATEDRATICO VALUES (10,4123005,'MATEMATICA', 25);
INSERT INTO CATEDRATICO VALUES (10,4122025,'HISTORIA', 15);
INSERT INTO CATEDRATICO VALUES (15,9800990,'INFORMATICA', 22);
INSERT INTO CATEDRATICO VALUES (15,1112346,'HISTORIA', 12);
INSERT INTO CATEDRATICO VALUES (15,8660990,'FILOSOFIA', 21);
INSERT INTO CATEDRATICO VALUES (22,7650000, 'INFORMATICA', 15);
INSERT INTO CATEDRATICO VALUES (45,43526789,'INFORMATICA', 10);
commit;

/*CONSULTAS*/

/*1. Muestra el dni, nombre, salario y universidad de los trabajadores que tenga un salario
comprendido entre 1800 y 2100 y que estan en una universidad privada (tipo=S)*/

SELECT DNI, TRA.NOMBRE, SALARIO, UNI.NOMBRE
FROM TRABAJADOR TRA, UNIVERSIDAD UNI
WHERE TRA.CODIGO = UNI.CODIGO AND SALARIO BETWEEN 1800 AND 2100 AND TIPO = 'S';

/*2. Código y nombre de todas las Universidades donde no haya trabajadores*/

SELECT CODIGO, NOMBRE
FROM UNIVERSIDAD
WHERE CODIGO NOT IN (SELECT CODIGO FROM TRABAJADOR);

SELECT CODIGO, NOMBRE
FROM UNIVERSIDAD
MINUS
SELECT TRABAJADOR.CODIGO, UNIVERSIDAD.NOMBRE
FROM TRABAJADOR, UNIVERSIDAD;

/*3. Mostrar por cada universidad (ha de salir el nombre y dirección) el numero de
trabajadores
◦ Variante: Idem que antes, pero Si la universidad no tiene trabajadores ha de salir 0*/

SELECT UNI.NOMBRE, DIRECCION, COUNT(TRA.CODIGO) "TRABAJADORES TOTALES"
FROM UNIVERSIDAD UNI, TRABAJADOR TRA
WHERE UNI.CODIGO = TRA.CODIGO
GROUP BY UNI.NOMBRE, DIRECCION;

--VARIANTE

SELECT UNI.NOMBRE, DIRECCION, COUNT(TRA.CODIGO) "TRABAJADORES TOTALES"
FROM UNIVERSIDAD UNI
LEFT JOIN TRABAJADOR TRA ON TRA.CODIGO = UNI.CODIGO
GROUP BY UNI.NOMBRE, DIRECCION;

SELECT UNI.NOMBRE, DIRECCION, COUNT(TRA.CODIGO) "TRABAJADORES TOTALES"
FROM UNIVERSIDAD UNI, TRABAJADOR TRA
WHERE UNI.CODIGO = TRA.CODIGO(+)
GROUP BY UNI.NOMBRE, DIRECCION;


/*4. Mostrar todos los datos de las trabajadores que esten en una universidad donde haya 3
catedráticos*/

SELECT *
FROM TRABAJADOR
WHERE CODIGO IN (SELECT CODIGO FROM (SELECT CODIGO, COUNT(*) FROM CATEDRATICO GROUP BY CODIGO HAVING COUNT(*) = 3));

/*5. Nombre del catedratico que tiene menos profesores a su cargo*/

SELECT NOMBRE
FROM TRABAJADOR TRA, CATEDRATICO CAT
WHERE CAT.DNI = TRA.DNI AND NPROF = (SELECT MIN(NPROF) FROM CATEDRATICO);

SELECT NOMBRE FROM TRABAJADOR
WHERE DNI = (
    SELECT DNI FROM CATEDRATICO WHERE NPROF= (SELECT MIN(NPROF) FROM CATEDRATICO));
    
/*6. Mostrar la pareja de nombre de trabajadores que tienen el mismo salario y que están en
distinta universidad*/

SELECT DISTINCT(T1.NOMBRE), T2.NOMBRE
FROM TRABAJADOR T1, TRABAJADOR T2
WHERE T1.SALARIO = T2.SALARIO AND T1.NOMBRE > T2.NOMBRE AND T1.CODIGO <> T2.CODIGO;

