CREATE TABLE UPERSONA
(
  NIF CHAR(9),
  NOMBRE VARCHAR2(25) NOT NULL,
  APELLIDO VARCHAR2(50) NOT NULL,
  CIUDAD VARCHAR2(25),
  DIRECCIONCALLE VARCHAR2(50),
  DIRECCIONNUM CHAR(3),
  TELEFONO CHAR(9),
  FECHANACIMIENTO DATE,
  VARON CHAR(1),
  CONSTRAINT PK_UPERSONA PRIMARY KEY(NIF),
  CONSTRAINT CK_VARON CHECK  (VARON IN ('0','1'))
 );



CREATE TABLE UPROFESOR
(
  IDPROFESOR CHAR(4),
  NIF CHAR(9),
  CONSTRAINT PK_UPROF PRIMARY KEY(IDPROFESOR),
  CONSTRAINT FK_UPROF_PER FOREIGN KEY(NIF) REFERENCES UPERSONA
); 



CREATE TABLE UALUMNO
(
  IDALUMNO CHAR(7),
  NIF CHAR(9),
  CONSTRAINT PK_UALUM PRIMARY KEY(IDALUMNO),
  CONSTRAINT FK_UALUM_PER FOREIGN KEY(NIF) REFERENCES UPERSONA
); 



CREATE TABLE UTITULACION
(
  IDTITULACION CHAR(6),
  NOMBRE VARCHAR2 (20) NOT NULL,
  CONSTRAINT PK_UTITUL PRIMARY KEY(IDTITULACION),
  CONSTRAINT CK_NOM UNIQUE(NOMBRE) 
 );
  

CREATE TABLE UASIGNATURA
(
 IDASIGNATURA CHAR(6),
 NOMBRE VARCHAR2(50) NOT NULL,
 CREDITOS NUMBER,
 CUATRIMESTRE CHAR(1),
 COSTEBASICO NUMBER(5,2),
 IDPROFESOR CHAR(4),
 IDTITULACION CHAR(6),
 CURSO CHAR(1),
 CONSTRAINT PK_UASIG PRIMARY KEY (IDASIGNATURA),
 CONSTRAINT CK_CRED CHECK (CREDITOS IN ('4.5','6','7.5','9')),
 CONSTRAINT CK_CUATR CHECK(CUATRIMESTRE IN ('1','2')),
 CONSTRAINT FK_UASIG_PROF FOREIGN KEY (IDPROFESOR) REFERENCES UPROFESOR,
 CONSTRAINT FK_UASIG_TIT FOREIGN KEY(IDTITULACION) REFERENCES UTITULACION,
 CONSTRAINT CK_CURSO CHECK(CURSO IN('1','2','3','4'))
);


CREATE TABLE UALUMNO_UASIGNATURA
(
  IDALUMNO CHAR(7),
  IDASIGNATURA CHAR(6),
  NUMEROMATRICULA NUMBER(1) NOT NULL,
  CONSTRAINT PK_MATRIC PRIMARY KEY (IDALUMNO,IDASIGNATURA),
  CONSTRAINT FK_UALUM FOREIGN KEY(IDALUMNO) REFERENCES UALUMNO,
  CONSTRAINT FK_ASIG FOREIGN KEY(IDASIGNATURA) REFERENCES UASIGNATURA,
  CONSTRAINT CK_MATRIC CHECK(NUMEROMATRICULA>=1 AND NUMEROMATRICULA<=6)
 );
 

INSERT INTO UPERSONA
VALUES('16161616A','Luis','Ramirez','Haro','Pez','34','941111111','1/1/69','1');
INSERT INTO UPERSONA 
VALUES('17171717A','Laura','Beltran','Madrid','Gran Via','23','912121212','8/8/74','0');
INSERT INTO UPERSONA
VALUES('18181818A','Pepe','Perez','Madrid','Percebe','13','913131313','2/2/80','1');
INSERT INTO UPERSONA
VALUES('19191919A','Juan','Sanchez','Bilbao','Melancolia','7','944141414','3/3/66','1');
INSERT INTO UPERSONA
VALUES('20202020A','Luis','Jimenez','Najera','Cigüena','15','941151515','3/3/79','1');
INSERT INTO UPERSONA
VALUES('21212121A','Rosa','Garcia','Haro','Alegria','16','941161616','4/4/78','0');
INSERT INTO UPERSONA
VALUES('23232323A','Jorge','Saenz','Logroño','Luis Ulloa','17','941171717','9/9/78','1');
INSERT INTO UPERSONA 
VALUES('24242424A','Maria','Gutierrez','Logroño','Avda. de la Paz','18','941181818','10/10/64','0');
INSERT INTO UPERSONA
VALUES('25252525A','Rosario','Diaz','Logroño','Percebe','19','941191919','11/11/71','0');
INSERT INTO UPERSONA
VALUES('26262626A','Elena','Gonzalez','Logroño','Percebe','20','941202020','5/5/75','0');
COMMIT;

REM UALUMNO
INSERT INTO UALUMNO VALUES('A010101','21212121A');
INSERT INTO UALUMNO VALUES('A020202','18181818A');
INSERT INTO UALUMNO VALUES('A030303','20202020A');
INSERT INTO UALUMNO VALUES('A040404','26262626A');
INSERT INTO UALUMNO VALUES('A121212','16161616A');
INSERT INTO UALUMNO VALUES('A131313','17171717A');
COMMIT;

REM UPROFESOR
INSERT INTO UPROFESOR VALUES('P101','19191919A');
INSERT INTO UPROFESOR VALUES('P117','25252525A');
INSERT INTO UPROFESOR VALUES('P203','23232323A');
INSERT INTO UPROFESOR VALUES('P204','26262626A');
INSERT INTO UPROFESOR VALUES('P304','24242424A');
COMMIT;

REM UTITULACION
INSERT INTO UTITULACION VALUES ('130110','Matematicas');
INSERT INTO UTITULACION VALUES ('150210','Quimicas');
INSERT INTO UTITULACION VALUES ('160000','Empresariales');
COMMIT;

REM UASIGNATURA
INSERT INTO UASIGNATURA VALUES ('000115','Seguridad vial',4.5,'1',30.00,'P204',NULL,'');
INSERT INTO UASIGNATURA VALUES ('130113','Progamacion I',9,'1',60.00,'P101','130110','1');
INSERT INTO UASIGNATURA VALUES ('130122','Analisis II',9,'2',60.00,'P203','130110','2');
INSERT INTO UASIGNATURA VALUES ('150212','Quimica Fisica',4.5,'2',70.00,'P304','150210','1');
INSERT INTO UASIGNATURA VALUES ('160002','Contabilidad',6,'1',70.00,'P117','160000','1');
COMMIT;


REM UALUMNO_UASIGNATURA
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A010101','150212',1);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A020202','130113',1);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A020202','150212',2);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A030303','130113',3);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A030303','150212',1);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A030303','130122',2);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A040404','130122',1);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A121212','000115',1);
INSERT INTO UALUMNO_UASIGNATURA VALUES ('A131313','160002',4);
COMMIT;

/*CONSULTAS*/

/*1. Cuantos alumnos hay matriculados en cada asignatura. (mostrar el idAsignatura )
Idem mostrando el nombre de cada asignatura.*/

SELECT ASIG.IDASIGNATURA, COUNT(ALU.IDALUMNO)
FROM UALUMNO ALU, UASIGNATURA ASIG, UALUMNO_UASIGNATURA ALUASI
WHERE ALU.IDALUMNO = ALUASI.IDALUMNO AND ASIG.IDASIGNATURA = ALUASI.IDASIGNATURA
GROUP BY ASIG.IDASIGNATURA;

SELECT ASIG.IDASIGNATURA, ASIG.NOMBRE, COUNT(ALU.IDALUMNO)
FROM UALUMNO ALU, UASIGNATURA ASIG, UALUMNO_UASIGNATURA ALUASI
WHERE ALU.IDALUMNO = ALUASI.IDALUMNO AND ASIG.IDASIGNATURA = ALUASI.IDASIGNATURA
GROUP BY ASIG.IDASIGNATURA, ASIG.NOMBRE;

/*2. Cual es el coste básico total en cada titulación.
Crear otra variante mostrando el nombre de la titulación.*/

SELECT TITU.IDTITULACION, SUM(COSTEBASICO)
FROM UASIGNATURA ASI, UTITULACION TITU
WHERE ASI.IDTITULACION = TITU.IDTITULACION
GROUP BY TITU.IDTITULACION;

SELECT TITU.IDTITULACION, TITU.NOMBRE, SUM(COSTEBASICO)
FROM UASIGNATURA ASI, UTITULACION TITU
WHERE ASI.IDTITULACION = TITU.IDTITULACION
GROUP BY TITU.IDTITULACION, TITU.NOMBRE;

/*3. Coste medio (pormedio) de las asignaturas de cada titulación, para aquellas titulaciones en el que
el coste total de la 1a matrícula sea mayor que 60 euros.*/

SELECT AVG(COSTEBASICO), IDTITULACION
FROM UASIGNATURA
GROUP BY IDTITULACION
HAVING SUM(COSTEBASICO) > 60;

/*4. Id de los alumnos matriculados en las asignaturas "150212" y "130113" a la vez.*/

SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA = '150212'
INTERSECT
SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA = '130113';
-
SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA IN ('150212', '130113')
GROUP BY IDALUMNO
HAVING COUNT(DISTINCT IDASIGNATURA) = 2;

/*5. Id de los alumnos matriculados en las asignatura "150212" ó "130113", en una o en otra pero no
en ambas a la vez.*/

SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA = '150212' OR IDASIGNATURA = '130113'
MINUS
(SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA = '150212'
INTERSECT
SELECT IDALUMNO
FROM UALUMNO_UASIGNATURA
WHERE IDASIGNATURA = '130113');

/*6. Mostrar el DNI de alumnos y profesores.*/

SELECT NIF FROM UALUMNO
UNION
SELECT NIF FROM UPROFESOR;

/*7. Lo mismo pero con filas repetidas:*/

SELECT NIF FROM UALUMNO
UNION ALL
SELECT NIF FROM UPROFESOR;

/*8. DNI de los profesores que también son alumnos.*/

SELECT NIF FROM UPROFESOR
INTERSECT
SELECT NIF FROM UALUMNO;

/*9. DNI de las personas que no son alumnos ni profesores.*/

SELECT NIF FROM UPERSONA
MINUS
SELECT NIF FROM UALUMNO
MINUS
SELECT NIF FROM UPROFESOR;

/*10. Lista de asignaturas en las que no se ha matriculado nadie.*/

SELECT IDASIGNATURA FROM UASIGNATURA
MINUS
SELECT IDASIGNATURA FROM UALUMNO_UASIGNATURA;

/*11. Ciudades en las que vive algún profesor y también algún alumno.*/

SELECT DISTINCT CIUDAD
FROM UPERSONA
WHERE NIF IN (SELECT NIF FROM UPROFESOR UNION SELECT NIF FROM UALUMNO);

/*12. Ciudades en las que vive algún profesor pero ningún alumno.*/

SELECT DISTINCT CIUDAD
FROM UPERSONA
WHERE NIF IN (SELECT NIF FROM UPROFESOR MINUS SELECT NIF FROM UALUMNO);




